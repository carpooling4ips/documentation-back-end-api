

<!DOCTYPE html>
<html lang="en">

<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> src/models/rideGroup.js</title>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="./build/entry.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>



<body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
            
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    API Documentation
                </a>
                
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar "
            id="sidebarNav"
        >
            
            <nav>
                
                    <h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Modules</h3><ul><li><a href="module-src_main.html">src/main</a></li></ul></div><div class="category"><h2>Controllers</h2><h3>Modules</h3><ul><li><a href="module-AuthController.html">AuthController</a></li><li><a href="module-DebugNotificationController.html">DebugNotificationController</a></li><li><a href="module-UserController.html">UserController</a></li><li><a href="module-UserProfileController.html">UserProfileController</a></li><li><a href="module-UserRideGroupController.html">UserRideGroupController</a></li><li><a href="module-UserRideScheduleController.html">UserRideScheduleController</a></li><li><a href="module-UserSettingsController.html">UserSettingsController</a></li><li><a href="module-UserUserBlacklistController.html">UserUserBlacklistController</a></li><li><a href="module-UserVehicleController.html">UserVehicleController</a></li></ul><h3>Classes</h3><ul><li><a href="module-AuthController.html">AuthController</a></li><li><a href="module-DebugNotificationController.html">DebugNotificationController</a></li><li><a href="module-UserController.html">UserController</a></li><li><a href="module-UserProfileController.html">UserProfileController</a></li><li><a href="module-UserRideGroupController.html">UserRideGroupController</a></li><li><a href="module-UserRideScheduleController.html">UserRideScheduleController</a></li><li><a href="module-UserSettingsController.html">UserSettingsController</a></li><li><a href="module-UserUserBlacklistController.html">UserUserBlacklistController</a></li><li><a href="module-UserVehicleController.html">UserVehicleController</a></li></ul></div><div class="category"><h2>Models</h2><h3>Modules</h3><ul><li><a href="module-ChatMessageModel.html">ChatMessageModel</a></li><li><a href="module-ChatRoomModel.html">ChatRoomModel</a></li><li><a href="module-NewsModel.html">NewsModel</a></li><li><a href="module-NotificationModel.html">NotificationModel</a></li><li><a href="module-RideGroupModel.html">RideGroupModel</a></li><li><a href="module-RideHistoryModel.html">RideHistoryModel</a></li><li><a href="module-RideRouteModel.html">RideRouteModel</a></li><li><a href="module-RideScheduleModel.html">RideScheduleModel</a></li><li><a href="module-UserModel.html">UserModel</a></li><li><a href="module-UserNotificationModel.html">UserNotificationModel</a></li><li><a href="module-VehicleModel.html">VehicleModel</a></li></ul></div><div class="category"><h2>Models.Schemas</h2><h3>Modules</h3><ul><li><a href="module-BoundarySchema.html">BoundarySchema</a></li><li><a href="module-FileSchema.html">FileSchema</a></li><li><a href="module-LocationSchema.html">LocationSchema</a></li><li><a href="module-PointSchema.html">PointSchema</a></li></ul></div><div class="category"><h2>Routes</h2><h3>Modules</h3><ul><li><a href="module-AuthRoute.html">AuthRoute</a></li><li><a href="module-DebugNotificationRoute.html">DebugNotificationRoute</a></li><li><a href="module-DebugRoute.html">DebugRoute</a></li><li><a href="module-UserProfileRoute.html">UserProfileRoute</a></li><li><a href="module-UserRideGroupRoute.html">UserRideGroupRoute</a></li><li><a href="module-UserRideScheduleRoute.html">UserRideScheduleRoute</a></li><li><a href="module-UserRoute.html">UserRoute</a></li><li><a href="module-UserSettingRoute.html">UserSettingRoute</a></li><li><a href="module-UserUserBlacklistRoute.html">UserUserBlacklistRoute</a></li><li><a href="module-UserVehicleRoute.html">UserVehicleRoute</a></li></ul></div><div class="category"><h2>Utils</h2><h3>Modules</h3><ul><li><a href="module-ApiError.html">ApiError</a></li><li><a href="module-NotificationManager.html">NotificationManager</a></li><li><a href="module-RideManager.html">RideManager</a></li><li><a href="module-Validator.html">Validator</a></li></ul><h3>Classes</h3><ul><li><a href="module-ApiError.html">ApiError</a></li><li><a href="module-NotificationManager.html">NotificationManager</a></li><li><a href="module-RideManager.html">RideManager</a></li></ul></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                <header class="page-title">
                    <p>Source</p>
                    <h1>src/models/rideGroup.js</h1>
                </header>
                



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module RideGroupModel
 * @category Models
 */

'use strict'

/*
 * ==================================================
 * | Imports                                        |
 * ==================================================
 */
import mongoose from 'mongoose'

import { REG_TIME } from '../utils/validator.js'

// Models
import { RideGroupModel, UserModel } from './index.js'

// Schemas
import PointSchema from './schemas/point.js'

/*
 * ==================================================
 * | Schemas                                        |
 * ==================================================
 */

/**
 * Passenger nested schema.
 *
 * @type {mongoose.Schema}
 * @property {mongoose.ObjectId}  userId  Passenger's user id.
 */
const PassengerSchema = new mongoose.Schema({
  userId: { type: mongoose.ObjectId, ref: 'User', required: true }
}, {
  timestamps: true
})

/**
 * Ride group schema.
 *
 * @type {mongoose.Schema}
 * @property {string}                 alias                             Ride group alias.
 * @property {mongoose.ObjectId}      driverId                          Ride group driver's user id.
 * @property {mongoose.ObjectId}      vehicleId                         Ride group driver's user vehicle id.
 * @property {Map&lt;PassengerSchema>}   [passengers]                      Ride group passengers.
 * @property {object}                 [recurrent]                       Ride group recurrent options.
 * @property {boolean}                [recurrent.weekDays.sunday]       Recurrent sunday week day.
 * @property {boolean}                [recurrent.weekDays.monday]       Recurrent monday week day.
 * @property {boolean}                [recurrent.weekDays.tuesday]      Recurrent tuesday week day.
 * @property {boolean}                [recurrent.weekDays.wednesday]    Recurrent wednesday week day.
 * @property {boolean}                [recurrent.weekDays.thursday]     Recurrent thursday week day.
 * @property {boolean}                [recurrent.weekDays.friday]       Recurrent friday week day.
 * @property {boolean}                [recurrent.weekDays.saturday]     Recurrent saturday week day.
 * @property {string}                 recurrent.departureTime           Recurrence departure time.
 * @property {Date}                   [recurrent.expiration]            Recurrence expiration date.
 * @property {boolean}                [recurrent.notifiedExpiration]    Recurrence already notified expiration.
 * @property {PointSchema}            meetingPoint                      Ride group meeting point.
 * @property {boolean}                toDestination                     Ride group is to or from destination.
 * @property {mongoose.ObjectId}      route                             Ride group route.
 * @property {mongoose.ObjectId[]}    [alternativeRoutes]               Ride group alternative routes.
 * @property {boolean}                [isDisabled]                      Ride group status (true if deleted).
 */
const RideGroupSchema = new mongoose.Schema({
  alias: {
    type: String,
    minlength: 3,
    maxlength: 64,
    trim: true,
    validate: {
      validator: async function (value) {
        // Validate if the user already has a ride group with the specified alias
        const userDuplicatedRideGroupAlias = await RideGroupModel.exists({
          _id: { $ne: this._id },
          driverId: this.driverId,
          alias: value,
          isDisabled: false
        })

        return !userDuplicatedRideGroupAlias
      },
      message: 'The specified alias is already in use by another of yours ride groups' // TODO Use i18n
    },
    required: true
  },
  driverId: { type: mongoose.ObjectId, ref: 'User', required: true },
  vehicleId: {
    type: mongoose.ObjectId,
    ref: 'Vehicle',
    validate: {
      validator: async function (value) {
        // Validate if the vehicle id is owned by the driver id
        const userOwnsVehicle = await UserModel.exists({
          _id: this.driverId,
          vehicles: { $in: [value] },
          isSuspended: false,
          isDisabled: false
        })

        return userOwnsVehicle
      },
      message: 'The specified vehicle\'s id is not owned by the specified driver\'s id' // TODO Use i18n
    },
    required: true
  },
  passengers: { type: Map, of: PassengerSchema },
  recurrent: {
    type: {
      weekDays: {
        type: {
          sunday: { type: Boolean },
          monday: { type: Boolean },
          tuesday: { type: Boolean },
          wednesday: { type: Boolean },
          thursday: { type: Boolean },
          friday: { type: Boolean },
          saturday: { type: Boolean }
        },
        validate: {
          validator: function (value) {
            return value.sunday === true || value.monday === true || value.tuesday === true || value.wednesday === true || value.thursday === true || value.friday === true || value.saturday === true
          },
          message: '"{PATH}" select at least one week day' // TODO Use i18n
        },
        required: true
      },
      departureTime: {
        type: String,
        match: REG_TIME,
        required: true
      },
      expiration: { type: Date },
      notifiedExpiration: { type: Boolean }
    }
  },
  meetingPoint: { type: PointSchema, required: true },
  toDestination: { type: Boolean, required: true },
  avoidTolls: { type: Boolean, required: true },
  route: { type: mongoose.ObjectId, ref: 'RideRoute' },
  alternativeRoutes: { type: [{ type: mongoose.ObjectId, ref: 'RideRoute' }] },
  isDisabled: { type: Boolean, select: false, required: true, default: false }
}, {
  timestamps: true
})

RideGroupSchema.index({ isDisabled: 1, notifiedExpiration: 1, expiration: -1 })
RideGroupSchema.index({ isDisabled: 1, driverId: 1 })
RideGroupSchema.index({ isDisabled: 1, passengers: 1 })
RideGroupSchema.index({ isDisabled: 1, toDestination: 1, meetingPoint: '2dsphere' })

/**
 * The data-layer for a ride group.
 *
 * @example &lt;caption>Example usage of RideGroup model.&lt;/caption>
 * let rideGroup1 = new RideGroup({
 *   alias: 'Ride Group 1',
 *   driverId: mongoose.Types.ObjectId('5f574fe68b17b9087e60ac0c'),
 *   vehicleId: mongoose.Types.ObjectId('5f574fefa720da3cd5969636'),
 *   passengers: {
 *     "5f58d33402d43cc486f197a0": { userId: mongoose.Types.ObjectId('5f58d33402d43cc486f197a0') },
 *     "5f58d33737da5e029c97c642": { userId: mongoose.Types.ObjectId('5f58d33737da5e029c97c642') }
 *   },
 *   recurrent: {
 *     weekDays: {
 *       monday: true,
 *       wednesday: true
 *     },
 *     departureTime: '12:45',
 *     expiration: new Date()
 *   },
 *   meetingPoint: { type: 'Point', coordinates: [-122, 37] },
 *   route: mongoose.Types.ObjectId('5f5a5069e1d4b4cf65507c53'),
 *   alternativeRoutes: [
 *     mongoose.Types.ObjectId('5f5a506c305ff6bd4475b1d1'),
 *     mongoose.Types.ObjectId('5f5a506fc35e608a4832f569')
 *   ],
 *   toDestination: true
 * });
 */
export default mongoose.model('RideGroup', RideGroupSchema)
</code></pre>
        </article>
    </section>




            </div>
            
            <footer class="footer">
                <div class="content has-text-centered">
                    <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a></p>
                    <p class="sidebar-created-by">
                        <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by 
                        <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
                    </p>
                </div>
            </footer>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>PR.prettyPrint();</script>
<script src="scripts/linenumber.js"> </script>

</body>
</html>
