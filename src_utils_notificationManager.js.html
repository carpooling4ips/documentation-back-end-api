

<!DOCTYPE html>
<html lang="en">

<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> src/utils/notificationManager.js</title>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="./build/entry.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>



<body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
            
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    API Documentation
                </a>
                
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar "
            id="sidebarNav"
        >
            
            <nav>
                
                    <h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Modules</h3><ul><li><a href="module-src_main.html">src/main</a></li></ul></div><div class="category"><h2>Controllers</h2><h3>Modules</h3><ul><li><a href="module-AuthController.html">AuthController</a></li><li><a href="module-DebugNotificationController.html">DebugNotificationController</a></li><li><a href="module-UserController.html">UserController</a></li><li><a href="module-UserProfileController.html">UserProfileController</a></li><li><a href="module-UserRideGroupController.html">UserRideGroupController</a></li><li><a href="module-UserRideScheduleController.html">UserRideScheduleController</a></li><li><a href="module-UserSettingsController.html">UserSettingsController</a></li><li><a href="module-UserUserBlacklistController.html">UserUserBlacklistController</a></li><li><a href="module-UserVehicleController.html">UserVehicleController</a></li></ul><h3>Classes</h3><ul><li><a href="module-AuthController.html">AuthController</a></li><li><a href="module-DebugNotificationController.html">DebugNotificationController</a></li><li><a href="module-UserController.html">UserController</a></li><li><a href="module-UserProfileController.html">UserProfileController</a></li><li><a href="module-UserRideGroupController.html">UserRideGroupController</a></li><li><a href="module-UserRideScheduleController.html">UserRideScheduleController</a></li><li><a href="module-UserSettingsController.html">UserSettingsController</a></li><li><a href="module-UserUserBlacklistController.html">UserUserBlacklistController</a></li><li><a href="module-UserVehicleController.html">UserVehicleController</a></li></ul></div><div class="category"><h2>Models</h2><h3>Modules</h3><ul><li><a href="module-ChatMessageModel.html">ChatMessageModel</a></li><li><a href="module-ChatRoomModel.html">ChatRoomModel</a></li><li><a href="module-NewsModel.html">NewsModel</a></li><li><a href="module-NotificationModel.html">NotificationModel</a></li><li><a href="module-RideGroupModel.html">RideGroupModel</a></li><li><a href="module-RideHistoryModel.html">RideHistoryModel</a></li><li><a href="module-RideRouteModel.html">RideRouteModel</a></li><li><a href="module-RideScheduleModel.html">RideScheduleModel</a></li><li><a href="module-UserModel.html">UserModel</a></li><li><a href="module-UserNotificationModel.html">UserNotificationModel</a></li><li><a href="module-VehicleModel.html">VehicleModel</a></li></ul></div><div class="category"><h2>Models.Schemas</h2><h3>Modules</h3><ul><li><a href="module-BoundarySchema.html">BoundarySchema</a></li><li><a href="module-FileSchema.html">FileSchema</a></li><li><a href="module-LocationSchema.html">LocationSchema</a></li><li><a href="module-PointSchema.html">PointSchema</a></li></ul></div><div class="category"><h2>Routes</h2><h3>Modules</h3><ul><li><a href="module-AuthRoute.html">AuthRoute</a></li><li><a href="module-DebugNotificationRoute.html">DebugNotificationRoute</a></li><li><a href="module-DebugRoute.html">DebugRoute</a></li><li><a href="module-UserProfileRoute.html">UserProfileRoute</a></li><li><a href="module-UserRideGroupRoute.html">UserRideGroupRoute</a></li><li><a href="module-UserRideScheduleRoute.html">UserRideScheduleRoute</a></li><li><a href="module-UserRoute.html">UserRoute</a></li><li><a href="module-UserSettingRoute.html">UserSettingRoute</a></li><li><a href="module-UserUserBlacklistRoute.html">UserUserBlacklistRoute</a></li><li><a href="module-UserVehicleRoute.html">UserVehicleRoute</a></li></ul></div><div class="category"><h2>Utils</h2><h3>Modules</h3><ul><li><a href="module-ApiError.html">ApiError</a></li><li><a href="module-NotificationManager.html">NotificationManager</a></li><li><a href="module-RideManager.html">RideManager</a></li><li><a href="module-Validator.html">Validator</a></li></ul><h3>Classes</h3><ul><li><a href="module-ApiError.html">ApiError</a></li><li><a href="module-NotificationManager.html">NotificationManager</a></li><li><a href="module-RideManager.html">RideManager</a></li></ul></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                <header class="page-title">
                    <p>Source</p>
                    <h1>src/utils/notificationManager.js</h1>
                </header>
                



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module NotificationManager
 * @category Utils
 */

'use strict'

/*
 * ==================================================
 * | Imports                                        |
 * ==================================================
 */
import firebaseAdmin from 'firebase-admin'
import stringInject from 'stringinject'
import luxon from 'luxon'
import debug from 'debug'

// Models
import { UserModel, NotificationModel, UserNotificationModel } from '../models/index.js'

/*
 * ==================================================
 * | Constants                                      |
 * ==================================================
 */
const { DateTime } = luxon

// Debug package
const debugApp = debug('carpooling4ips')
const debugNotificationManager = debugApp.extend('notificationManager')

/*
 * ==================================================
 * | Exports                                        |
 * ==================================================
 */

/**
 * Class representing the firebase (FCM) notification manager.
 *
 * @category Utils
 */
export default class NotificationManager {
  /**
   * Initialize firebase admin sdk
   */
  static initialize () {
    firebaseAdmin.initializeApp({
      credential: firebaseAdmin.credential.applicationDefault()
    })
  }

  /**
   * Send notification to the array of users
   *
   * @param {string}  userIdArray         The array of users' id to send the notification.
   * @param {string}  notificationKey     The sending notification's key.
   * @param {object}  notificationParams  The object with placeholders parameters to fullfil the notification body.
   * @param {object}  notificationData    The object with extra data required by the notification type.
   */
  static async sendAll (userIdArray, notificationKey, notificationParams = {}, notificationData = {}) {
    for (const userId of userIdArray) {
      NotificationManager.send(userId, notificationKey, notificationParams, notificationData)
    }
  }

  /**
   * Send notification to the specified user
   *
   * @param {string}    userId              The user's id to send the notification.
   * @param {string}    notificationKey     The sending notification's key.
   * @param {object}    notificationParams  The object with placeholders parameters to fullfil the notification body.
   * @param {object}    notificationData    The object with extra data required by the notification type.
   * @param {boolean}   debug               False if exceptions must be catch silently.
   */
  static async send (userId, notificationKey, notificationParams = {}, notificationData = {}, debug = false) {
    try {
      // Retrieve user's firebase token and locale from the database
      const userDoc = await UserModel.findOne({
        _id: userId,
        isSuspended: false,
        isDisabled: false
      }, {
        locale: true,
        fcmToken: true
      })
        .lean()
        .exec()
      if (!userDoc || !userDoc.fcmToken) {
        throw new Error('The user does not exist or does not have a firebase cloud messaging token.')
      }

      // Retrieve notification data from the database
      const notificationDoc = await NotificationModel.findOne({
        key: notificationKey
      })
        .lean()
        .exec()

      // Get the notification data for the user locale
      const locale = userDoc.locale ? userDoc.locale.substring(0, 2) : process.env.DEFAULT_LOCALE
      const title = notificationDoc.title[locale]
      const body = notificationDoc.body[locale]
      const type = notificationDoc.type.toString()

      // Handle notification extra data
      const extraData = {}
      Object.keys(notificationDoc.data).forEach(key => {
        extraData[key] = '' + notificationDoc.data[key]
      })
      Object.keys(notificationData).forEach(key => {
        if (typeof notificationData[key] === 'object') {
          extraData['ext_' + key] = JSON.stringify(notificationData[key])
        } else {
          extraData['ext_' + key] = '' + notificationData[key]
        }
      })

      // Handle notification parameters
      const params = { ...notificationParams }
      if (Object.keys(params).includes('RIDE_SCHEDULE_DATE')) {
        params.RIDE_SCHEDULE_DATE = DateTime.fromJSDate(params.RIDE_SCHEDULE_DATE).setLocale(locale).toLocaleString(DateTime.DATETIME_FULL)
      }
      if (Object.keys(params).includes('RIDE_SCHEDULE_STATUS')) {
        switch (locale) {
          case 'en':
            switch (params.RIDE_SCHEDULE_STATUS) {
              case 1: params.RIDE_SCHEDULE_STATUS = 'Scheduled'
                break
              case 2: params.RIDE_SCHEDULE_STATUS = 'Waiting for Passengers'
                break
              case 3: params.RIDE_SCHEDULE_STATUS = 'Started'
                break
              case 4: params.RIDE_SCHEDULE_STATUS = 'Finished'
                break
              case 5: params.RIDE_SCHEDULE_STATUS = 'Canceled'
                break
            }
            break
          case 'pt':
            switch (params.RIDE_SCHEDULE_STATUS) {
              case 1: params.RIDE_SCHEDULE_STATUS = 'Agendado'
                break
              case 2: params.RIDE_SCHEDULE_STATUS = 'À Espera de Passageiros'
                break
              case 3: params.RIDE_SCHEDULE_STATUS = 'Iniciado'
                break
              case 4: params.RIDE_SCHEDULE_STATUS = 'Finalizado'
                break
              case 5: params.RIDE_SCHEDULE_STATUS = 'Cancelado'
                break
            }
            break
        }
      }
      const formattedBody = stringInject.default(body, params)

      // Prepare sending message
      const message = {
        notification: {
          title: title,
          body: formattedBody
        },
        data: {
          type: type,
          ...extraData
        },
        token: userDoc.fcmToken,
        android: {
          data: {
            click_action: 'FLUTTER_NOTIFICATION_CLICK'
          }
        }
      }
      console.dir(message)
      const messageId = await firebaseAdmin.messaging().send(message)

      // Add the notification to the history
      const userNotificationDoc = new UserNotificationModel({
        userId: userId,
        notificationId: notificationDoc._id,
        params: params,
        locale: locale,
        rawMessage: formattedBody,
        fcmMessageCode: messageId
      })
      await userNotificationDoc.save()
    } catch (err) {
      if (debug) {
        throw err
      } else {
        debugNotificationManager(err)
      }
    }
  }
}
</code></pre>
        </article>
    </section>




            </div>
            
            <footer class="footer">
                <div class="content has-text-centered">
                    <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a></p>
                    <p class="sidebar-created-by">
                        <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by 
                        <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
                    </p>
                </div>
            </footer>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>PR.prettyPrint();</script>
<script src="scripts/linenumber.js"> </script>

</body>
</html>
